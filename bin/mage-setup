#!/bin/sh
echo "Initializing setup..."

if [ -f /src/app/etc/config.php ] || [ -f /src/app/etc/env.php ]; then
  echo "It appears Magento is already installed (app/etc/config.php or app/etc/env.php exist). Exiting setup..."
  exit
fi

if [ "$M2SETUP_USE_ARCHIVE" = true ]; then
  echo "Downloading and untarring archive..."
  if [ "$M2SETUP_USE_SAMPLE_DATA" = true ]; then
    curl -L https://storage.googleapis.com/mageinferno-docker-magento2-setup/magento-ce-$M2SETUP_VERSION-sd.tar.gz | tar xzf - -o -C /src
  else
    curl -L https://storage.googleapis.com/mageinferno-docker-magento2-setup/magento-ce-$M2SETUP_VERSION.tar.gz | tar xzf - -o -C /src
  fi
else
  rm -fr /src/*
  git clone $M2SETUP_PROJECT_URL /src
  cd /src && git checkout tags/$M2SETUP_VERSION
  /usr/local/bin/php -d memory_limit=2G /usr/local/bin/composer install -vvv
fi

chmod +x /src/bin/magento

if [ "$M2SETUP_USE_SAMPLE_DATA" = true ]; then
  echo "Install sample data..."
  /usr/local/bin/php -d memory_limit=2G /usr/local/bin/composer require magento/module-catalog-sample-data:100.0.*
  /usr/local/bin/php -d memory_limit=2G /usr/local/bin/composer require magento/module-cms-sample-data:100.0.*
fi

echo "Running Magento 2 setup script..."
/usr/local/bin/php -d memory_limit=2G /src/bin/magento setup:install \
  --backend-frontname=admin \
  --db-host=$M2SETUP_DB_HOST \
  --db-name=$M2SETUP_DB_NAME \
  --db-user=$M2SETUP_DB_USER \
  --db-password=$M2SETUP_DB_PASSWORD \
  --base-url=$M2SETUP_BASE_URL \
  --admin-firstname=$M2SETUP_ADMIN_FIRSTNAME \
  --admin-lastname=$M2SETUP_ADMIN_LASTNAME \
  --admin-email=$M2SETUP_ADMIN_EMAIL \
  --admin-user=$M2SETUP_ADMIN_USER \
  --admin-password=$M2SETUP_ADMIN_PASSWORD \
  --use-sample-data


echo "Reindexing all indexes..."
/usr/local/bin/php -d memory_limit=2G /src/bin/magento indexer:reindex

echo "Cache clean and flush..."
/usr/local/bin/php -d memory_limit=2G /src/bin/magento cache:clean
/usr/local/bin/php -d memory_limit=2G /src/bin/magento cache:flush

echo "Set the 'developer' magento mode..."
/usr/local/bin/php -d memory_limit=2G /src/bin/magento deploy:mode:set developer

echo "Disable the maintenance mode..."
/usr/local/bin/php -d memory_limit=2G /src/bin/magento maintenance:disable

echo "Setup upgrade and dicompile..."
/usr/local/bin/php -d memory_limit=2G /src/bin/magento setup:upgrade
rm -fr /src/var/di/
/usr/local/bin/php -d memory_limit=2G /src/bin/magento setup:di:compile


echo "Applying ownership & proper permissions..."
find /src -type d -exec chmod 770 {} \; && find /src -type f -exec chmod 660 {} \; && chmod u+x /src/bin/magento
chmod -R 777 /src/var/ && chmod -R 777 /src/pub/

echo "The setup script has completed execution."
